# soundcloud-widget-react — Full Reference

The definitive React wrapper for the SoundCloud HTML5 Widget API.
Version: 2.0.0 | License: MIT | npm: soundcloud-widget-react
Peer deps: react >= 17, react-dom >= 17 | Zero runtime dependencies

---

# src/types.ts

```ts
import type { CSSProperties, HTMLAttributeReferrerPolicy } from "react";

export enum SCWidgetEvents {
  READY = "ready",
  PLAY = "play",
  PAUSE = "pause",
  FINISH = "finish",
  SEEK = "seek",
  PLAY_PROGRESS = "play_progress",
  LOAD_PROGRESS = "load_progress",
  CLICK_BUY = "click_buy",
  CLICK_DOWNLOAD = "click_download",
  OPEN_SHARE_PANEL = "open_share_panel",
  ERROR = "error",
}

export interface SCWidgetParams {
  autoPlay?: boolean;
  color?: string;
  buying?: boolean;
  sharing?: boolean;
  download?: boolean;
  showArtwork?: boolean;
  showPlaycount?: boolean;
  showUser?: boolean;
  startTrack?: number;
  singleActive?: boolean;
  showTeaser?: boolean;
  visual?: boolean;
  liking?: boolean;
  showComments?: boolean;
  hideRelated?: boolean;
}

export interface SCAudioEventPayload {
  relativePosition: number;  // 0-1
  loadProgress: number;      // 0-1
  currentPosition: number;   // milliseconds
}

export interface SCSound {
  id: number;
  title: string;
  permalink_url: string;
  artwork_url: string | null;
  user: { username: string; permalink_url: string };
  duration: number;
}

export interface SCWidgetInstance {
  bind(eventName: string, listener: (e?: SCAudioEventPayload) => void): void;
  unbind(eventName: string): void;
  load(url: string, options?: Partial<SCWidgetParams> & { callback?: () => void }): void;
  play(): void;
  pause(): void;
  toggle(): void;
  seekTo(milliseconds: number): void;
  setVolume(volume: number): void;
  next(): void;
  prev(): void;
  skip(soundIndex: number): void;
  getVolume(callback: (volume: number) => void): void;
  getDuration(callback: (duration: number) => void): void;
  getPosition(callback: (position: number) => void): void;
  getSounds(callback: (sounds: SCSound[]) => void): void;
  getCurrentSound(callback: (sound: SCSound) => void): void;
  getCurrentSoundIndex(callback: (index: number) => void): void;
  isPaused(callback: (paused: boolean) => void): void;
}

export type SCWidgetEventMap = {
  [SCWidgetEvents.READY]: undefined;
  [SCWidgetEvents.PLAY]: SCAudioEventPayload;
  [SCWidgetEvents.PAUSE]: SCAudioEventPayload;
  [SCWidgetEvents.FINISH]: SCAudioEventPayload;
  [SCWidgetEvents.SEEK]: SCAudioEventPayload;
  [SCWidgetEvents.PLAY_PROGRESS]: SCAudioEventPayload;
  [SCWidgetEvents.LOAD_PROGRESS]: SCAudioEventPayload;
  [SCWidgetEvents.CLICK_BUY]: undefined;
  [SCWidgetEvents.CLICK_DOWNLOAD]: undefined;
  [SCWidgetEvents.OPEN_SHARE_PANEL]: undefined;
  [SCWidgetEvents.ERROR]: undefined;
};

export interface SCWidgetRef {
  // Controls
  play(): void;
  pause(): void;
  toggle(): void;
  seekTo(milliseconds: number): void;
  setVolume(volume: number): void;
  next(): void;
  prev(): void;
  skip(soundIndex: number): void;
  load(url: string, options?: Partial<SCWidgetParams> & { callback?: () => void }): void;
  // Callback-style getters
  getVolume(callback: (volume: number) => void): void;
  getDuration(callback: (duration: number) => void): void;
  getPosition(callback: (position: number) => void): void;
  getSounds(callback: (sounds: SCSound[]) => void): void;
  getCurrentSound(callback: (sound: SCSound) => void): void;
  getCurrentSoundIndex(callback: (index: number) => void): void;
  isPaused(callback: (paused: boolean) => void): void;
  // Promise-based getters (v2)
  getDurationAsync(): Promise<number>;
  getPositionAsync(): Promise<number>;
  getVolumeAsync(): Promise<number>;
  getSoundsAsync(): Promise<SCSound[]>;
  getCurrentSoundAsync(): Promise<SCSound>;
  getCurrentSoundIndexAsync(): Promise<number>;
  isPausedAsync(): Promise<boolean>;
}

export interface SCWidgetProps extends SCWidgetParams {
  url: string;
  width?: string | number;
  height?: string | number;
  style?: CSSProperties;
  className?: string;
  iframeId?: string;
  // iframe attributes
  title?: string;
  loading?: "eager" | "lazy";
  allow?: string;           // default: "autoplay"
  sandbox?: string;
  referrerPolicy?: HTMLAttributeReferrerPolicy;
  hidden?: boolean;         // render 1x1 invisible iframe, ignores layout props
  // Named event handlers
  onReady?: (ctx: { widget: SCWidgetInstance }) => void;
  onPlay?: (e: SCAudioEventPayload) => void;
  onPause?: (e: SCAudioEventPayload) => void;
  onFinish?: (e: SCAudioEventPayload) => void;
  onSeek?: (e: SCAudioEventPayload) => void;
  onPlayProgress?: (e: SCAudioEventPayload) => void;
  onLoadProgress?: (e: SCAudioEventPayload) => void;
  onError?: () => void;
  onClickDownload?: () => void;
  onClickBuy?: () => void;
  onOpenSharePanel?: () => void;
  // Generic event map (additive with named handlers)
  onEvent?: { [K in SCWidgetEvents]?: (payload: SCWidgetEventMap[K]) => void };
}

export interface SCWidgetState {
  isReady: boolean;
  isPlaying: boolean;
  positionMs: number;
  durationMs: number;
  sound: SCSound | null;
  soundIndex: number;
}
```

---

# src/index.ts

```ts
export { SCWidget } from "./SCWidget";
export { SCWidget as default } from "./SCWidget";
export { useSCWidget } from "./useSCWidget";
export { SCWidgetEvents } from "./types";
export type {
  SCWidgetRef, SCWidgetProps, SCWidgetParams, SCAudioEventPayload,
  SCSound, SCWidgetInstance, SCWidgetState, SCWidgetEventMap,
} from "./types";
```

---

# src/useScript.ts

Singleton script loader. Deduplicates across multiple widget mounts.
Returns: `{ loaded: boolean; error: Error | null }`

Handles:
- `window.SC` already present (beforeInteractive Next.js Script) — resolves immediately
- Script tag in DOM but not yet executed — polls until `window.SC` appears (10s timeout)
- Network/CSP errors — resets singleton, surfaces via error state
- Unmount before resolve — mounted flag prevents state updates on unmounted components

---

# src/SCWidget.tsx

`forwardRef` component. Key behaviors:
- Builds iframe src via URLSearchParams (no double-encoding)
- Initializes `SC.Widget` once script loaded + iframe mounted (singleton init guard)
- Binds all 11 Widget API events; calls both named prop AND `onEvent[event]` (additive)
- `onReady` passes `{ widget: SCWidgetInstance }` to handler
- Stable callback refs — handlers update without re-binding the widget
- URL/param changes call `widget.load()` — no iframe remount, no flicker
- `hidden=true`: renders `position:absolute, 1x1px, visibility:hidden, pointerEvents:none`
- `allow` defaults to `"autoplay"` if not provided

---

# src/useSCWidget.ts

Hook signature:
```ts
function useSCWidget(): {
  ref: React.RefObject<SCWidgetRef | null>;
  state: SCWidgetState;
  props: Pick<SCWidgetProps, "onReady" | "onPlay" | "onPause" | "onFinish" | "onPlayProgress">;
  controls: {
    play(): void;
    pause(): void;
    toggle(): void;
    seekTo(ms: number): void;
    setVolume(volume: number): void;
    next(): void;
    prev(): void;
    skip(index: number): void;
    load(url: string, options?: Partial<SCWidgetParams> & { callback?: () => void }): void;
  };
}
```

State updates:
- `onReady`: fetches `durationMs`, `sound`, `soundIndex` via async getters; sets `isReady=true`
- `onPlay`: `isPlaying=true`
- `onPause` / `onFinish`: `isPlaying=false`
- `onPlayProgress`: `positionMs=e.currentPosition`

All controls are stable `useCallback` refs — safe to use in dependency arrays.

---

# Usage Examples

## Basic usage

```tsx
import { SCWidget } from "soundcloud-widget-react";

export default function App() {
  return (
    <SCWidget
      url="https://soundcloud.com/artist/track"
      autoPlay={false}
      showArtwork={true}
      onReady={({ widget }) => console.log("Widget ready", widget)}
      onPlay={(e) => console.log("Playing at", e.currentPosition)}
      onFinish={() => console.log("Track finished")}
    />
  );
}
```

## useSCWidget (recommended)

```tsx
import { SCWidget, useSCWidget } from "soundcloud-widget-react";

export default function Player() {
  const { ref, state, props, controls } = useSCWidget();

  return (
    <div>
      <SCWidget ref={ref} url="https://soundcloud.com/artist/track" {...props} />

      <p>
        {state.isPlaying ? "Playing" : "Paused"} —{" "}
        {Math.round(state.positionMs / 1000)}s / {Math.round(state.durationMs / 1000)}s
      </p>
      {state.sound && <p>Now playing: {state.sound.title}</p>}

      <button onClick={controls.play}>Play</button>
      <button onClick={controls.pause}>Pause</button>
      <button onClick={controls.toggle}>Toggle</button>
      <button onClick={() => controls.seekTo(30_000)}>Seek to 0:30</button>
      <button onClick={() => controls.setVolume(0.5)}>50% volume</button>
    </div>
  );
}
```

## Generic onEvent

```tsx
import { SCWidget, SCWidgetEvents } from "soundcloud-widget-react";

<SCWidget
  url="https://soundcloud.com/artist/track"
  onEvent={{
    [SCWidgetEvents.READY]: () => console.log("ready"),
    [SCWidgetEvents.PLAY]: (e) => console.log("play at", e.currentPosition),
    [SCWidgetEvents.PLAY_PROGRESS]: (e) => console.log("progress", e.relativePosition),
    [SCWidgetEvents.ERROR]: () => console.error("player error"),
  }}
/>
```

## Hidden / controller-only

```tsx
import { SCWidget, useSCWidget } from "soundcloud-widget-react";

export default function InvisiblePlayer() {
  const { ref, state, props, controls } = useSCWidget();

  return (
    <div>
      <SCWidget ref={ref} url="https://soundcloud.com/artist/track" hidden autoPlay {...props} />
      <button onClick={controls.toggle}>{state.isPlaying ? "Pause" : "Play"}</button>
      <span>{Math.round(state.positionMs / 1000)}s</span>
    </div>
  );
}
```

## Promise-based getters

```tsx
import { useRef } from "react";
import { SCWidget, SCWidgetRef } from "soundcloud-widget-react";

export default function Player() {
  const playerRef = useRef<SCWidgetRef>(null);

  const logInfo = async () => {
    const duration = await playerRef.current?.getDurationAsync() ?? 0;
    const position = await playerRef.current?.getPositionAsync() ?? 0;
    const sound = await playerRef.current?.getCurrentSoundAsync();
    console.log(`${sound?.title}: ${position}ms / ${duration}ms`);
  };

  return (
    <>
      <SCWidget ref={playerRef} url="https://soundcloud.com/artist/track" />
      <button onClick={logInfo}>Log Info</button>
    </>
  );
}
```

## Next.js Option A — dynamic import

```tsx
import dynamic from "next/dynamic";

const SCWidget = dynamic(
  () => import("soundcloud-widget-react").then((m) => m.SCWidget),
  { ssr: false }
);

export default function Page() {
  return <SCWidget url="https://soundcloud.com/artist/track" />;
}
```

## Next.js Option B — beforeInteractive in root layout

```tsx
// app/layout.tsx
import Script from "next/script";

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html>
      <body>
        {children}
        <Script
          strategy="beforeInteractive"
          src="https://w.soundcloud.com/player/api.js"
        />
      </body>
    </html>
  );
}
```

```tsx
// components/PlayerBar.tsx
"use client";
import { SCWidget } from "soundcloud-widget-react";

export function PlayerBar({ url }: { url: string }) {
  return <SCWidget url={url} height={166} width="100%" autoPlay />;
}
```

## Instagram in-app browser fallback

```tsx
const { ref, state, props, controls } = useSCWidget();

return (
  <>
    <SCWidget ref={ref} url={url} {...props} hidden />
    {!state.isPlaying && (
      <button onClick={controls.play}>Tap to play</button>
    )}
  </>
);
```

---

# Migration: v1 → v2

BREAKING: `onReady` signature changed
- Before: `onReady?: () => void`
- After:  `onReady?: (ctx: { widget: SCWidgetInstance }) => void`
- Fix:    `onReady={() => ...}` → `onReady={({ widget }) => ...}`

NEW exports: `useSCWidget`, `SCWidgetEvents`, `SCWidgetState`, `SCWidgetEventMap`

NEW props: `onEvent`, `title`, `loading`, `allow`, `sandbox`, `referrerPolicy`, `hidden`, `visual`, `liking`, `showComments`, `hideRelated`

NEW ref methods: `*Async()` Promise variants for all getters

---

# Known Limitations

- Instagram in-app browser: blocks autoplay, play() must be from user gesture. Show fallback button.
- CSP: add `frame-src https://w.soundcloud.com` and `script-src https://w.soundcloud.com`
